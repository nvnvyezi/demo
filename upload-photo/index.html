<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>头像上传</title>
  <style>
    .img {
      width: 300px;
      height: 200px;
    }
    .img img {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="img">
    <img id="img" src="" alt="" />
  </div>
  <form action="">
    <input type="file" name="image" id="image" accept="" onchange="handleImage()" />
  </form>
  <canvas id="canvas"></canvas>
  <script>
    // -------- 将以base64的图片url数据转换为Blob --------
    function convert (urlData, fileType) {
      let bytes = window.atob(urlData.split(',')[1]);
      // console.log(bytes);
      let ab = new ArrayBuffer(bytes.length);
      let ia = new Uint8Array(ab);
      for (i = 0; i < bytes.length; i++) {
        ia[i] = bytes.charCodeAt(i);
      }
      let nnn = new Blob([ab], {type: fileType});
      console.log(nnn);
      return nnn;
    }
    function handleImage () {
      let files = document.getElementById('image').files;
      console.log(files)
      let fileType = files[0].type;
      let name = files[0].name;
      // let formData = new FormData();
      // for (let i = 0; i < files.length; i++) {
      //   formData.append(`file${i}`, files[i], files[i].name);
      // }
      // let xhr = new XMLHttpRequest();
      // xhr.open('post', 'http://127.0.0.1:3000/update');
      // xhr.onreadystatechange = () => {
      //   if (xhr.readyState == 4 && xhr.status == 200) {
      //     console.log(xhr);
      //   }
      // }
      // xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      // xhr.send(formData);
      if(!(window.FileReader && window.File && window.FileList && window.Blob)){
        alert('不支持')
      }
      let reader = new FileReader();
      reader.onload = (e) => {
      //   console.log(e)
        let img = document.getElementById('img');
        img.src = e.target.result;
        let data = e.target.result;
        let canvas = document.getElementById("canvas");
        canvas.width = 300;
        canvas.height = 200;
        let context = canvas.getContext("2d");
        let imgg = new Image();
        imgg.src = e.target.result;
        imgg.onload = function(){
          console.log(this.width)
            context.drawImage(imgg, 100, 450, 140, 140, 0, 0, 140, 140);
        }
        // let ajax = new XMLHttpRequest();
        // let formData = new FormData();
        // formData.append('image', convert(data, fileType), name);
        // // formData.append('image', data, name);
        // ajax.open('post', 'http://127.0.0.1:3000/update');
        // // ajax.setRequestHeader("Content-type","multipart/form-data");
        // console.log(formData.get('image'));
        // ajax.send(formData);
        // ajax.onreadystatechange = () => {
        //   if (ajax.readyState == 4 && ajax.status == 200) {
        //     console.log(ajax)
        //   }
        // }
      }
      reader.readAsDataURL(files[0])
    }
  </script>
</body>
</html>